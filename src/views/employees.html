<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../public/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <title>WorkAlign - Employees</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #f6f9fb;
        }

        .container-fluid,
        .row {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .col-md-9 {
            height: calc(100vh - 56px);
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 30px;

        }

        .create-employee-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .btn-create {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }

        .btn-view {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .btn-delete {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        .employees-section {
            margin-top: 40px;
        }

        .section-title {
            margin-bottom: 20px;
            color: #343a40;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        .table-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .dataTables_wrapper {
            margin-top: 15px;
        }

        table.dataTable {
            border-collapse: collapse !important;
        }

        table.dataTable thead th {
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
        }

        table.dataTable tbody td {
            border-top: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .table-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background-color: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }

        .loading-state,
        .empty-state,
        .error-state {
            text-align: center;
            place-items: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i,
        .error-state i {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
            display: block;
        }

        .error-state i {
            color: #dc3545;
        }

        .error-state div {
            margin-bottom: 1rem;
            font-size: 1.1em;
            color: #dc3545;
        }

        #employeesTable tbody td[colspan="6"] {
            padding: 0 !important;
            border: none !important;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .retry-btn {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="../../public/index.html">
            <i class="fa-solid fa-users-gear" style="color: #ffffff;"></i> WorkAlign
        </a>

        <!-- Button of menu mobile -->
        <button class="navbar-toggler d-md-none" type="button" data-toggle="collapse" data-target="#navbarMobileMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu mobile (dropdown) -->
        <div class="collapse navbar-collapse d-md-none" id="navbarMobileMenu">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="../../public/index.html" data-menu="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="employees.html" data-menu="employees">
                        <i class="fas fa-users"></i> Employees
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="departments.html" data-menu="departments">
                        <i class="fas fa-briefcase"></i> Departments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="reports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Side menu -->
            <div class="col-md-3 menu d-none d-md-block">
                <ul class="menu">
                    <li>
                        <a href="../../public/index.html" class="menu-item" data-menu="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="employees.html" class="menu-item active" data-menu="employees">
                            <i class="fas fa-users"></i>
                            <span>Employees</span>
                        </a>
                    </li>
                    <li>
                        <a href="departments.html" class="menu-item" data-menu="departments">
                            <i class="fas fa-briefcase"></i>
                            <span>Departments</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="menu-item" data-menu="reports">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main content -->
            <div class="col-md-9 main-content">
                <!-- Create New Employee -->
                <div class="create-employee-btn-container">
                    <a href="register_employee.html">
                        <button type="button" class="btn btn-primary btn-sm btn-create">
                            <i class="fas fa-plus"></i> New Employee
                        </button>
                    </a>
                </div>

                <!-- List of employees-->
                <div class="employees-section">
                    <div class="table-container">
                        <h3 class="section-title">Employees</h3>
                        <table id="employeesTable" class="table table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Department</th>
                                    <th>Role</th>
                                    <th>Salary</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic data -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
    <script src="../../public/js/script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Marcar o menu de employees como ativo
            const menuItems = document.querySelectorAll('.menu-item, #navbarMobileMenu .nav-link');
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-menu') === 'employees') {
                    item.classList.add('active');
                }
            });

            localStorage.setItem('activeMenu', 'employees');

        });

        $(document).ready(function () {
            const table = $('#employeesTable');
            const tbody = table.find('tbody');
            let dataTableInstance = null; // Variable to control the DataTable instance.

            // Table states
            function showLoadingState() {
                tbody.html(`
            <tr>
                <td colspan="6">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>Loading employees...</div>
                    </div>
                </td>
            </tr>
        `);
            }

            function showEmptyState() {
                tbody.html(`
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <div>No employees registered in the database.</div>
                    </div>
                </td>
            </tr>
        `);
            }

            function showErrorState(message) {
                tbody.html(`
            <tr>
                <td colspan="6">
                    <div class="error-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>${message}</div>
                        <button class="btn btn-primary retry-btn">Try Again</button>
                    </div>
                </td>
            </tr>
        `);
            }

            function clearTableBody() {
                tbody.empty();
            }

            // Load employees from API
            function loadEmployees() {
                showLoadingState();

                $.ajax({
                    url: '../controllers/get_employees.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        if (response.employees && response.employees.length > 0) {
                            renderTable(response.employees);
                        } else {
                            showEmptyState();
                            // If there was a DataTable, destroy it.
                            if (dataTableInstance) {
                                dataTableInstance.destroy();
                                dataTableInstance = null;
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        let message = "An error occurred while loading employees.";
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            message = xhr.responseJSON.error;
                        }
                        showErrorState(message);
                        if (dataTableInstance) {
                            dataTableInstance.destroy();
                            dataTableInstance = null;
                        }
                    }
                });
            }

            // Populate the table with data and initialize the DataTable.
            function renderTable(employees) {
                if (dataTableInstance) {
                    dataTableInstance.destroy();
                    dataTableInstance = null;
                }

                // Clean and populate the tbody
                clearTableBody();
                populateTable(employees);

                initializeDataTable();
            }

            // Popular table with data
            function populateTable(employees) {
                // Loop through employees and create rows
                employees.forEach(emp => {
                    const row = `
                <tr>
                    <td>${emp.name}</td>
                    <td>${emp.age}</td>
                    <td>${emp.department}</td>
                    <td>${emp.role}</td>
                    <td>$${emp.salary}</td>
                    <td class="text-center">
                        <div class="table-actions">
                            <button class="btn btn-sm btn-view" data-id="${emp.id}" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-delete" data-id="${emp.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
                    tbody.append(row);
                });
            }

            // Initialize DataTable;
            function initializeDataTable() {
                dataTableInstance = table.DataTable({
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    },
                    columnDefs: [
                        { orderable: false, targets: 5 } // Disable sorting in the actions column.
                    ]
                });
            }

            function deleteEmployee(employeeId) {
                if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
                    const deleteBtn = $(`.btn-delete[data-id="${employeeId}"]`);
                    const originalHtml = deleteBtn.html();
                    deleteBtn.html('<i class="fas fa-spinner fa-spin"></i>');
                    deleteBtn.prop('disabled', true);

                    $.ajax({
                        url: '../controllers/delete_employee.php',
                        type: 'DELETE',
                        contentType: 'application/json',
                        data: JSON.stringify({ id: employeeId }),
                        dataType: 'json',
                        success: function (response) {
                            if (response.success) {
                                // Reload the table after deleting.
                                loadEmployees();
                                showNotification('Employee deleted successfully!', 'success');
                            } else {
                                showNotification('Error: ' + response.error, 'error');
                            }
                        },
                        error: function (xhr, status, error) {
                            let message = "An error occurred while deleting the employee.";
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                message = xhr.responseJSON.error;
                            }
                            showNotification(message, 'error');
                        },
                        complete: function () {
                            // Restore the button
                            deleteBtn.html(originalHtml);
                            deleteBtn.prop('disabled', false);
                        }
                    });
                }
            }

            function showNotification(message, type = 'info') {
                if (type === 'error') {
                    alert('Error: ' + message);
                } else {
                    alert(message);
                }
            }

            // Button delete event
            $(document).on('click', '.btn-delete', function (e) {
                e.preventDefault();
                const employeeId = $(this).data('id');
                deleteEmployee(employeeId);
            });

            // Event for the view button - redirects to the employee details page.
            $(document).on('click', '.btn-view', function (e) {
                e.preventDefault();
                const employeeId = $(this).data('id');
                window.location.href = `employee_details.html?id=${employeeId}`;
            });

            // Event to retry in case of error.
            $(document).on('click', '.retry-btn', function () {
                loadEmployees();
            });

            loadEmployees();
        });
    </script>
</body>

</html>
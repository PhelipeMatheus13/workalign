<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../public/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.css">
    <title>WorkAlign - new employee</title>
    <style>
        body {
            overflow: hidden;
        }

        .col-md-9 {
            overflow-y: auto;
        }

        .card-employees {
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 10px; 
            background: white;
        }

        .form-title {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-actions {
            margin-top: 5px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="../../public/index.html">
            <i class="fa-solid fa-users-gear" style="color: #ffffff;"></i> WorkAlign
        </a>
        
        <!-- Botão do menu mobile -->
        <button class="navbar-toggler d-md-none" type="button" data-toggle="collapse" data-target="#navbarMobileMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu mobile (dropdown) -->
        <div class="collapse navbar-collapse d-md-none" id="navbarMobileMenu">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="../../public/index.html" data-menu="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="employees.html" data-menu="employees">
                        <i class="fas fa-users"></i> Employees
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="departments.html" data-menu="departments">
                        <i class="fas fa-briefcase"></i> Departments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="reports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- MENU LATERAL -->
            <div class="col-md-3 menu d-none d-md-block">
                <ul class="menu">
                    <li>
                        <a href="../../public/index.html" class="menu-item" data-menu="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="employees.html" class="menu-item" data-menu="employees">
                            <i class="fas fa-users"></i>
                            <span>Employees</span>
                        </a>
                    </li>
                    <li>
                        <a href="departments.html" class="menu-item" data-menu="departments">
                            <i class="fas fa-briefcase"></i>
                            <span>Departments</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="menu-item" data-menu="reports">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- CONTEÚDO PRINCIPAL -->
            <div class="col-md-9">
                <div class="row">
                    <div class="col-md card-employees">
                         <h3 class="form-title">Register New Employee</h3>
                        <form id="employeeForm" action="../controllers/register_employee.php" method="POST">
                            <!-- First Name, Last Name, Date of Birth -->
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="first_name">First Name *</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name" placeholder="Enter first name" required>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="last_name">Last Name *</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name" placeholder="Enter last name" required>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="date_of_birth">Date of Birth *</label>
                                    <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                                </div>
                            </div>

                            <!-- Email and Phones -->
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="email">Email Address *</label>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="Enter email address" required>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="phone1">Primary Phone *</label>
                                    <input type="tel" class="form-control" id="phone1" name="phone1" placeholder="(123) 456-7890" required>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="phone2">Secondary Phone</label>
                                    <input type="tel" class="form-control" id="phone2" name="phone2" placeholder="(123) 456-7890">
                                    <small class="form-text text-muted">Optional</small>
                                </div>
                            </div>

                            <!-- Address -->
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label for="address">Address *</label>
                                    <input type="text" class="form-control" id="address" name="address" placeholder="Enter complete address" required>
                                </div>
                            </div>
                            
                            <!-- Salary, Department, Role -->
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="salary">Salary ($) *</label>
                                    <input type="number" class="form-control" id="salary" name="salary" placeholder="0.00" step="0.01" min="0" required>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="department">Department *</label>
                                    <select class="form-control" id="department" name="department_id" required>
                                        <option value="">Loading departments...</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="role">Role *</label>
                                    <select class="form-control" id="role" name="role_id" disabled required>
                                        <option value="">Select Department First</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Register Employee</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="../../public/js/script.js"></script>
  
    <script>
        // Script específico para garantir que o menu de employees fique ativo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Register employee page loaded - setting active menu');
            
            // Forçar o menu employees como ativo
            const menuItems = document.querySelectorAll('.menu-item, #navbarMobileMenu .nav-link');
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-menu') === 'employees') {
                    item.classList.add('active');
                }
            });
            
            // Salvar no localStorage que estamos em employees
            localStorage.setItem('activeMenu', 'employees');

            // Carregar departamentos e funções
            loadDepartmentsAndRoles();
        });

        // Variável global para armazenar os dados
        let departmentsData = [];

        // Carregar departamentos e funções do servidor
        function loadDepartmentsAndRoles() {
            const departmentSelect = document.getElementById('department');
            const roleSelect = document.getElementById('role');
            
            // Mostrar estado de carregamento
            showLoadingState();

            console.log('Starting to load departments and roles...');
            
            fetch('../controllers/get_departments_with_roles.php')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data received from server:', data);
                    
                    if (data.success && data.data && data.data.length > 0) {
                        departmentsData = data.data;
                        console.log(`Loaded ${data.data.length} departments with roles`);
                        populateDepartmentSelect();
                    } else if (data.success && (!data.data || data.data.length === 0)) {
                        console.log('No departments found in database');
                        showEmptyState();
                    } else {
                        throw new Error(data.error || 'Unknown server error');
                    }
                })
                .catch(error => {
                    console.error('Error loading departments and roles:', error);
                    showErrorState();
                });
        }

        // Mostrar estado de carregamento
        function showLoadingState() {
            const departmentSelect = document.getElementById('department');
            const roleSelect = document.getElementById('role');
            
            departmentSelect.innerHTML = `
                <option value="">
                    <i class="fas fa-spinner fa-spin"></i> Loading departments...
                </option>
            `;
            roleSelect.innerHTML = '<option value="">Select department first</option>';
            roleSelect.disabled = true;
        }

        // Preencher select de departamentos
        function populateDepartmentSelect() {
            const departmentSelect = document.getElementById('department');
            
            // Limpar options anteriores
            departmentSelect.innerHTML = '<option value="">Select Department</option>';
            
            // Adicionar cada departamento
            departmentsData.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.department_id;
                option.textContent = dept.department_display;
                option.setAttribute('data-full-name', dept.department_name);
                option.setAttribute('data-roles', JSON.stringify(dept.roles));
                departmentSelect.appendChild(option);
            });
            
            console.log('Department select populated with', departmentsData.length, 'options');
        }

        // Mostrar estado vazio 
        function showEmptyState() {
            const departmentSelect = document.getElementById('department');
            const roleSelect = document.getElementById('role');
            
            departmentSelect.innerHTML = `
                <option value="">
                    <i class="fas fa-search"></i> No departments found
                </option>
            `;
            departmentSelect.disabled = true;
            
            roleSelect.innerHTML = '<option value="">No roles available</option>';
            roleSelect.disabled = true;
            
            console.log('Empty state shown - no departments with roles found');
        }

        // Mostrar estado de erro
        function showErrorState() {
            const departmentSelect = document.getElementById('department');
            const roleSelect = document.getElementById('role');
            
            departmentSelect.innerHTML = `
                <option value="">
                    <i class="fas fa-exclamation-triangle"></i> Error - reload page
                </option>
            `;
            departmentSelect.disabled = true;
            
            roleSelect.innerHTML = '<option value="">Error</option>';
            roleSelect.disabled = true;
            
            console.log('Error state shown - failed to load departments');
        }

        // Atualizar funções com base no departamento selecionado
        document.getElementById('department').addEventListener('change', function() {
            const roleSelect = document.getElementById('role');
            const selectedDeptId = this.value;
            
            // Limpar options anteriores
            roleSelect.innerHTML = '<option value="">Select Role</option>';
            
            if (selectedDeptId) {
                // Habilitar e popular o select de roles
                roleSelect.disabled = false;
                
                const selectedOption = this.options[this.selectedIndex];
                const roles = JSON.parse(selectedOption.getAttribute('data-roles'));
                
                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.role_id;
                        option.textContent = role.role_name;
                        roleSelect.appendChild(option);
                    });
                    console.log(`Populated role select with ${roles.length} roles for department ${selectedDeptId}`);
                } else {
                    roleSelect.innerHTML = '<option value="">No roles available</option>';
                    roleSelect.disabled = true;
                    console.log('No roles found for selected department');
                }
            } else {
                // Desabilitar se nenhum departamento selecionado
                roleSelect.disabled = true;
                roleSelect.innerHTML = '<option value="">Select department first</option>';
            }
        });

        // Validação do formulário antes do envio
        document.getElementById('employeeForm').addEventListener('submit', function(e) {
            const departmentId = document.getElementById('department').value;
            const roleId = document.getElementById('role').value;
            
            if (!departmentId || !roleId) {
                e.preventDefault();
                alert('Please select both department and role before submitting.');
                return;
            }
            
            // Validação adicional pode ser adicionada aqui
            console.log('Form submitted with department_id:', departmentId, 'and role_id:', roleId);
        });
    </script>
</body>
</html>